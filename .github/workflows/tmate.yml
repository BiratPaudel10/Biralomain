name: BiraloVPS 24/7 Auto Backup

on:
  repository_dispatch:
    types: [create-vps]  # <-- Enables Discord bot to trigger this workflow
  workflow_dispatch:     # Optional: allows you to trigger manually from GitHub
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

env:
  GIT_TOKEN: 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  # Replace with your actual PAT

jobs:
  tmate-session:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y tmate curl tar git

    - name: Restore backup
      run: |
        chmod +x ./backup-restore.sh
        ./backup-restore.sh restore_backup || echo "No backup found."

    - name: Start tmate session and keep alive
      run: |
        tmate -F | tee session.log &
        sleep 15
        grep -E 'ssh|https://tmate.io' session.log || echo "❌ No SSH link found."

    - name: Save SSH link to file
      run: |
        mkdir -p links
        SSH_LINK=$(grep -o 'ssh [^ ]*@[^ ]*' session.log | tail -1)
        echo "$SSH_LINK" > links/latest.txt
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add links/latest.txt
        git commit -m "🔗 Update latest SSH link"
        git push https://${GIT_TOKEN}@github.com/${{ github.repository }} HEAD:main

    - name: Keep session alive for 6 hours
      run: sleep 21600

    - name: Backup data before shutdown
      run: |
        ./backup-restore.sh backup_and_upload || echo "Backup failed."
