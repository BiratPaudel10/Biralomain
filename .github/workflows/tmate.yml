name: BiraloVPS 24/7 Auto Backup

on:
  repository_dispatch:
    types: [create-vps]  # Triggered by Discord bot
  schedule:
    - cron: '0 */6 * * *'  # Optional: runs every 6 hours automatically

jobs:
  tmate-session:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Test network connectivity
      run: |
        curl -v https://tmate.io || echo "‚ö†Ô∏è Failed to reach tmate.io"
        nc -zv sfo2.tmate.io 22 || echo "‚ö†Ô∏è Port 22 to tmate server blocked"

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y tmate curl tar netcat

    - name: Restore backup (optional)
      run: |
        if [ -f "./backup-restore.sh" ]; then
          chmod +x ./backup-restore.sh
          ./backup-restore.sh restore_backup || echo "‚ö†Ô∏è No backup found."
        else
          echo "‚ö†Ô∏è No backup script found. Skipping restore."
        fi

    - name: Start tmate session and log SSH link
      run: |
        tmate -F | tee session.log &
        sleep 30  # wait for tmate session to be ready
        grep -E 'ssh|https://tmate.io' session.log || echo "‚ùå No SSH link found."

    - name: Debug tmate logs
      run: cat session.log

    - name: Save SSH link to repo
      run: |
        mkdir -p links
        SSH_LINK=$(grep -o 'ssh [^ ]*@[^ ]*' session.log | tail -1)
        echo "$SSH_LINK" > links/latest.txt
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add links/latest.txt
        git commit -m "üîó Update latest SSH link" || echo "Nothing to commit"
        git push || echo "‚ö†Ô∏è Failed to push SSH link."

    - name: Keep session alive (6 hours)
      run: sleep 21600

    - name: Backup before shutdown (optional)
      run: |
        if [ -f "./backup-restore.sh" ]; then
          ./backup-restore.sh backup_and_upload || echo "‚ö†Ô∏è Backup failed."
        else
          echo "‚ö†Ô∏è No backup script found. Skipping backup."
        fi
