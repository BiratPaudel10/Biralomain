name: VPS Runner

on:
  repository_dispatch:
    types: [create-vps]

jobs:
  run-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 4320 # Max allowed by GitHub: 72 hours
    steps:

    - name: Setup VPS name
      run: |
        echo "VPS_NAME=${{ github.event.client_payload.vps_name }}" >> $GITHUB_ENV
        echo "BACKUP=${{ github.event.client_payload.backup }}" >> $GITHUB_ENV

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Backup old data (if any)
      if: env.BACKUP == 'true'
      run: |
        echo "Backup enabled for $VPS_NAME (optional logic here)"

    - name: Install Tmate
      run: |
        sudo apt update
        sudo apt install -y tmate
        mkdir -p links

    - name: Start tmate session
      run: |
        tmate -S vps_${VPS_NAME}.sock new-session -d
        tmate -S vps_${VPS_NAME}.sock wait tmate-ready
        TMATE_SSH=$(tmate -S vps_${VPS_NAME}.sock display -p '#{tmate_ssh}')
        echo "$TMATE_SSH" > links/${VPS_NAME}.txt
        echo "TMATE_SSH=$TMATE_SSH" >> $GITHUB_ENV

    - name: Commit SSH link to repo
      uses: EndBug/add-and-commit@v9
      with:
        author_name: github-actions
        author_email: github-actions@github.com
        message: "ğŸ” Updated SSH for ${{ env.VPS_NAME }}"
        add: "links/${{ env.VPS_NAME }}.txt"

    - name: Output SSH link
      run: echo "ğŸ” SSH link: $TMATE_SSH"

    - name: Keep VPS alive for 72 hours
      run: sleep 259200 # 72 hours in seconds
