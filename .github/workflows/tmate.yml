name: Create VPS

on:
  repository_dispatch:
    types: [create-vps]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: ⬇️ Checkout
        uses: actions/checkout@v3

      - name: 🔁 Set up tmate
        uses: mxschmitt/action-tmate@v3

      - name: 📁 Create directories
        run: mkdir -p links .backup

      - name: 💾 Restore backup if exists
        run: |
          if [ -f ".backup/${{ github.event.client_payload.vps_name }}.zip" ]; then
            unzip ".backup/${{ github.event.client_payload.vps_name }}.zip" -d .
          fi

      - name: ⚙️ Start tmate session and wait for it
        run: |
          echo "🔑 Starting tmate session..."
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          echo "$SSH" > "links/${{ github.event.client_payload.vps_name }}.txt"
          echo "SSH session ready: $SSH"
          sleep 50  # Give the user time to connect

      - name: 📦 Zip current state as backup
        run: |
          zip -r ".backup/${{ github.event.client_payload.vps_name }}.zip" . -x ".git/*" ".github/*" ".backup/*"

      - name: 📤 Push SSH and backup to repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🔁 Updated SSH + backup for ${{ github.event.client_payload.vps_name }}"
